<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Statistical guarantees and long-term error rates in A/B testing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="stat guarantees_files/libs/clipboard/clipboard.min.js"></script>
<script src="stat guarantees_files/libs/quarto-html/quarto.js"></script>
<script src="stat guarantees_files/libs/quarto-html/popper.min.js"></script>
<script src="stat guarantees_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="stat guarantees_files/libs/quarto-html/anchor.min.js"></script>
<link href="stat guarantees_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="stat guarantees_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="stat guarantees_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="stat guarantees_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="stat guarantees_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

<script src="stat guarantees_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="stat guarantees_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Statistical guarantees and long-term error rates in A/B testing</h1>
<p class="subtitle lead">Why considering just Type I and II error rates is not sufficient</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Suppose you’re the <em>Head of Something Data Related</em> in a company that runs many experiments annually, and your job is to ensure that the experimentation program is trustworthy. It’s still in the early stages of the experimentation journey in this company, so most tests use null hypothesis testing (NHT) with fixed sample sizes (although you’re looking into sequential testing and CUPED, too). You set the following rules for every experiment:</p>
<ul>
<li><p>Only experiments with a p-value &lt; 0.05 will be considered as having conclusive outcomes (you target a Type I error rate <span class="math inline">\(\alpha=0.05\)</span>).</p></li>
<li><p>Every experiment should be run with a predetermined sample size, which implies a power of 80% (you target a Type II error rate <span class="math inline">\(\beta=0.1\)</span>).</p></li>
</ul>
<p>Setting aside the considerations on whether these are the <a href="https://aurimas.eu/blog/2023/02/getting-faster-to-decisions-in-a-b-tests-part-2-misinterpretations-and-practical-challenges-of-classical-hypothesis-testing/">best thresholds and other issues with using NHT</a>, here’s one question that, arguably, should matter to someone responsible for an experimentation program:</p>
<blockquote class="blockquote">
<p>What long-term error rates (a.k.a. bad decisions) can I expect if I run the experimentation program with such parameters?</p>
</blockquote>
<p>It may seem the answer is simply Type I and Type II error rates, or, “We will detect (i.e., declare them as statistically significant) differences when they exist, 80% of the time, and, in 5% of the cases we detect differences, they will be due to imperfect sampling randomization and not true differences”. But that is only true under a few conditions:</p>
<ul>
<li><p>When estimating the required sample size in every experiment, you will always choose MDE precisely equal to the actual unobservable difference for that specific experiment.</p></li>
<li><p>You will have some experiments in which the actual difference is precisely zero—not “close enough to zero” but literally zero.</p></li>
</ul>
<p>Neither of these conditions is likely to hold in the real world, which is why Type I and II error rates aren’t likely to represent the long-term error rates. They have not been designed for that. Instead, they represent frequentist statistics and its definition of probability—the likelihood of observing the same results if you repeat the same experiment over and over.</p>
<p>As a <em>Head of Something Data,</em> however, you’re not only interested in whether the results of a particular experiment hold. You (should!) want to know what the long-term error rates are.</p>
<p>For that, we need some other measures &amp; some other tools.</p>
<section id="moving-beyond-type-i-error-rates-type-m-and-s-errors" class="level2">
<h2 class="anchored" data-anchor-id="moving-beyond-type-i-error-rates-type-m-and-s-errors">Moving beyond Type I error rates: Type M and S errors</h2>
<p>Type I error rate, <span class="math inline">\(\alpha\)</span> is the most known statistical concept among everyone, including non-technical stakeholders. It’s probably the most misinterpreted one, too, given all the issues people have with p-values.</p>
<p>For something so popular, I’d argue it’s not so valuable because:</p>
<ul>
<li><p>It’s independent of the sample size. Isn’t that weird? No matter how much data you collect, you’re guaranteed that, if there’s no underlying difference, 5% of the time, you will still find statistically significant differences in the data when using a p-value of 0.05. Intuitively, one would think that more data equals more confidence in results, but the Type I error rate doesn’t change! Yes, the estimates become tighter, but Type I error rate doesn’t measure that.</p></li>
<li><p>How often do you run experiments that have precisely no impact? Hopefully, never. So you’ll never need to worry about it! It’s tempting to approximate zero with “effect sizes so small they don’t matter,” but Type I error rates say nothing about small effect sizes.</p></li>
</ul>
<p><a href="https://journals.sagepub.com/doi/10.1177/1745691614551642">Gelman and Carlin</a> (2014) introduced two other metrics that I think are much more useful to consider:</p>
<ul>
<li>Type S (sign) error: the probability that an observed difference, when declared as statistically significant, has an opposite sign than the true difference. In other words, the probability that you will be making a decision that’s opposite to what you are really after.</li>
<li>Type M (Magnitude) error: a measure of how much the observed difference, when declared as statistically significant, is different from true difference, expressed as a ratio (<span class="math inline">\(\frac{\text{observed difference}}{\text{true difference}}\)</span>). It helps quantify the magnitude of winner’s curse phenomenon, as well as partially addresses the issue with quantifying risk of declaring “effect sizes so small that they don’t practically matter” as statistically significant.</li>
</ul>
<p>Type M and S error rates directly translate to business implications, unlike Type I error. They become smaller as sample sizes increase, as they operate in the “when alternative hypothesis is true” land, i.e.&nbsp;in situations when the effect sizes are not exactly zero.</p>
<section id="calculating-type-s-and-m-error-rates" class="level3">
<h3 class="anchored" data-anchor-id="calculating-type-s-and-m-error-rates">Calculating Type S and M error rates</h3>
<p>The original paper proposed calculating Type S and M error rates via simulation using the following function, where <span class="math inline">\(A\)</span> is the effect size, <span class="math inline">\(s\)</span> is the standard error, <span class="math inline">\(\alpha\)</span> is the chosen level of statistical significance, and <span class="math inline">\(df\)</span> represents the degrees of freedom.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>retrodesign <span class="ot">&lt;-</span> <span class="cf">function</span>(A, s, <span class="at">alpha=</span>.<span class="dv">05</span>, <span class="at">df=</span><span class="cn">Inf</span>, <span class="at">n.sims=</span><span class="dv">10000</span>){</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">&lt;-</span> <span class="fu">qt</span>(<span class="dv">1</span><span class="sc">-</span>alpha<span class="sc">/</span><span class="dv">2</span>, df)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  p.hi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">pt</span>(z<span class="sc">-</span>A<span class="sc">/</span>s, df)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  p.lo <span class="ot">&lt;-</span> <span class="fu">pt</span>(<span class="sc">-</span>z<span class="sc">-</span>A<span class="sc">/</span>s, df)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  power <span class="ot">&lt;-</span> p.hi <span class="sc">+</span> p.lo</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  typeS <span class="ot">&lt;-</span> p.lo<span class="sc">/</span>power</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  estimate <span class="ot">&lt;-</span> A <span class="sc">+</span> s<span class="sc">*</span><span class="fu">rt</span>(n.sims,df)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  significant <span class="ot">&lt;-</span> <span class="fu">abs</span>(estimate) <span class="sc">&gt;</span> s<span class="sc">*</span>z</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  exaggeration <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(estimate)[significant])<span class="sc">/</span>A</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">power=</span>power, <span class="at">typeS=</span>typeS, <span class="at">typeM=</span>exaggeration))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we wanted to compute the metrics for a hypothetical A/B test with a binary outcome metric (e.g.&nbsp;conversion rate) where the baseline is <em>17%,</em> MDE of interest is <em>1ppt</em>, and sample size was 6000 users in each group:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n_group <span class="ot">=</span> <span class="dv">6000</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>baseline <span class="ot">=</span> <span class="fl">0.17</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate the baseline variance</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>baseline_var <span class="ot">=</span> baseline <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> baseline)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate standard error by estimating pooled variance</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>st_error <span class="ot">=</span> <span class="fu">sqrt</span>(baseline_var <span class="sc">/</span> n_group <span class="sc">+</span> baseline_var <span class="sc">/</span> n_group)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#degrees of freedom is N*2 - 2</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>df_test <span class="ot">=</span> n_group <span class="sc">*</span> <span class="dv">2</span> <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">#use Gelman's function to get error rate estimates</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="fu">retrodesign</span>(<span class="at">A=</span>delta, <span class="at">s=</span>st_error, <span class="at">df =</span> df_test) <span class="sc">|&gt;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">'Estimated Metrics'</span>) <span class="sc">|&gt;</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Estimated Metrics</caption>
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">power</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">typeS</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">typeM</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.3081444</td>
<td style="text-align: right;">0.0010259</td>
<td style="text-align: right;">1.785657</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We can validate power calculations using R’s built-in function - power estimates are very close (differences due to simulation error).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">power.prop.test</span>(<span class="at">n=</span>n_group, <span class="at">p1=</span>baseline, <span class="at">p2 =</span> baseline <span class="sc">+</span> delta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     Two-sample comparison of proportions power calculation 

              n = 6000
             p1 = 0.17
             p2 = 0.18
      sig.level = 0.05
          power = 0.3020516
    alternative = two.sided

NOTE: n is number in *each* group</code></pre>
</div>
</div>
<p>When you click the <strong>Render</strong> button a document will be generated that includes both content and the output of embedded code. You can embed code like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">2000</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>sd <span class="ot">=</span> <span class="fl">0.2</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">power.t.test</span>(<span class="at">n=</span>n, <span class="at">delta=</span>mu, <span class="at">sd=</span>sd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     Two-sample t test power calculation 

              n = 2000
          delta = 0.01
             sd = 0.2
      sig.level = 0.05
          power = 0.3522678
    alternative = two.sided

NOTE: n is number in *each* group</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>calculate_rates <span class="ot">=</span> <span class="cf">function</span>(delta, sd, n) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">=</span> <span class="fu">abs</span>(delta) <span class="sc">/</span> <span class="fu">sqrt</span>(sd<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>n <span class="sc">+</span> sd<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>n)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">=</span> <span class="fu">qnorm</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.05</span><span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  neg <span class="ot">=</span> <span class="fu">pnorm</span>(<span class="sc">-</span>z <span class="sc">-</span>lambda)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  diff <span class="ot">=</span> <span class="fu">pnorm</span>(z <span class="sc">-</span> lambda)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  pos <span class="ot">=</span> <span class="fu">pnorm</span>(z <span class="sc">+</span> lambda)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  inv_diff <span class="ot">=</span> <span class="fu">pnorm</span>(lambda <span class="sc">-</span> z)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">power =</span> neg <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> diff,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">sign_error =</span> neg <span class="sc">/</span> (neg <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> diff),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">m_ratio =</span> (<span class="fu">dnorm</span>(lambda <span class="sc">+</span> z) <span class="sc">+</span> <span class="fu">dnorm</span>(lambda <span class="sc">-</span> z) <span class="sc">+</span> lambda <span class="sc">*</span> (pos <span class="sc">+</span> inv_diff <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">/</span> (lambda <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> pos <span class="sc">+</span> inv_diff))</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="fu">calculate_rates</span>(<span class="sc">-</span>mu, sd, n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$power
[1] 0.3526081

$sign_error
[1] 0.0005650158

$m_ratio
[1] 1.666241</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">retrodesign</span>(mu, <span class="fu">sqrt</span>(sd<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>n <span class="sc">+</span> sd<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>n), <span class="at">df=</span>n<span class="sc">*</span><span class="dv">2-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$power
[1] 0.3523996

$typeS
[1] 0.0005705167

$typeM
[1] 1.664708</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">benchmark</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"my"</span> <span class="ot">=</span> { <span class="fu">calculate_rates</span>(mu, sd, n)},</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"def"</span> <span class="ot">=</span> { <span class="fu">power.t.test</span>(<span class="at">n=</span>n, <span class="at">delta=</span>mu, <span class="at">sd=</span>sd)},</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gel"</span> <span class="ot">=</span> {<span class="fu">retrodesign</span>(mu, <span class="fu">sqrt</span>(sd<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>n <span class="sc">+</span> sd<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>n), <span class="at">df=</span>n<span class="sc">*</span><span class="dv">2-2</span>)},</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">replications =</span> <span class="dv">1000</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  test replications elapsed relative user.self sys.self user.child sys.child
2  def         1000   0.047    5.222     0.047     0.00          0         0
3  gel         1000   1.068  118.667     0.989     0.08          0         0
1   my         1000   0.009    1.000     0.009     0.00          0         0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>baseline <span class="ot">=</span> <span class="fl">0.17</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>n_group <span class="ot">=</span> <span class="dv">6000</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>sd_treatment_effect <span class="ot">=</span> <span class="fl">0.015</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>avg_treatment_effect <span class="ot">=</span> <span class="fl">0.003</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>eff_size_generator_normal <span class="ot">=</span> <span class="cf">function</span>()  {</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rnorm</span>(<span class="dv">1</span>, avg_treatment_effect, sd_treatment_effect)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>eff_size_density_normal <span class="ot">=</span> <span class="cf">function</span>(x) {</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(x, <span class="at">mean =</span> avg_treatment_effect, <span class="at">sd =</span> sd_treatment_effect) </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>eff_size_generator_gamma <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rgamma</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>) <span class="sc">/</span> <span class="dv">50</span> <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">50</span> <span class="sc">+</span> avg_treatment_effect</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>eff_size_density_gamma <span class="ot">=</span> <span class="cf">function</span>(x) {</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dgamma</span>((x <span class="sc">-</span> avg_treatment_effect <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">50</span>) <span class="sc">*</span> <span class="dv">50</span>, <span class="dv">2</span>, <span class="dv">2</span>) <span class="sc">*</span> <span class="dv">50</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>eff_size_density <span class="ot">=</span> eff_size_density_gamma</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>eff_size_generator <span class="ot">=</span> eff_size_generator_gamma</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="fu">power.prop.test</span>(<span class="at">n=</span>n_group, <span class="at">p1=</span>baseline, <span class="at">p2 =</span> baseline <span class="sc">+</span> avg_treatment_effect)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     Two-sample comparison of proportions power calculation 

              n = 6000
             p1 = 0.17
             p2 = 0.173
      sig.level = 0.05
          power = 0.06374695
    alternative = two.sided

NOTE: n is number in *each* group</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">stat_function</span>(<span class="at">fun =</span> eff_size_density) <span class="sc">+</span> <span class="fu">xlim</span>(<span class="sc">-</span><span class="fl">0.05</span>, <span class="fl">0.05</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="stat-guarantees_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">integrate</span>(<span class="cf">function</span>(x) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eff_size_density</span>(x) <span class="sc">*</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace_na</span>(<span class="fu">power.prop.test</span>(<span class="at">n=</span>n_group, <span class="at">p1=</span>baseline, <span class="at">p2=</span>baseline <span class="sc">+</span> x)<span class="sc">$</span>power, <span class="dv">0</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>}, <span class="sc">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.3294766 with absolute error &lt; 8.7e-05</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>baseline_sd <span class="ot">=</span> <span class="fu">sqrt</span>(baseline <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> baseline))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">integrate</span>(<span class="cf">function</span>(x) {</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">=</span> <span class="fu">calculate_rates</span>(<span class="at">n=</span>n_group, <span class="at">delta=</span>x, <span class="at">sd=</span>baseline_sd)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">eff_size_density</span>(x) <span class="sc">*</span> (r<span class="sc">$</span>m_ratio <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">abs</span>(x) <span class="sc">*</span> r<span class="sc">$</span>power</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>}, <span class="sc">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>, <span class="at">stop.on.error =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.001628884 with absolute error &lt; 7e-05</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">integrate</span>(<span class="cf">function</span>(x) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">=</span> <span class="fu">calculate_rates</span>(<span class="at">n=</span>n_group, <span class="at">delta=</span>x, <span class="at">sd=</span>baseline_sd)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  r<span class="sc">$</span>sign_error <span class="sc">*</span> r<span class="sc">$</span>power <span class="sc">*</span> <span class="fu">eff_size_density</span>(x)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>}, <span class="sc">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>, <span class="at">stop.on.error =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.003975783 with absolute error &lt; 9.1e-07</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">stat_function</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun =</span> <span class="cf">function</span>(x) { </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">=</span> <span class="fu">retrodesign</span>(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">A=</span>x, <span class="at">s=</span><span class="fu">sqrt</span>(sd_baseline<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>n_group <span class="sc">+</span> sd_baseline<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>n_group), </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">df=</span>n_group<span class="sc">*</span><span class="dv">2-2</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abs</span>(r<span class="sc">$</span>exaggeration)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> <span class="fu">xlim</span>(<span class="sc">-</span><span class="fl">0.05</span>, <span class="fl">0.05</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Computation failed in `stat_function()`
Caused by error in `fun()`:
! object 'sd_baseline' not found</code></pre>
</div>
<div class="cell-output-display">
<p><img src="stat-guarantees_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">retrodesign</span>(<span class="fl">0.00001</span>, <span class="fu">sqrt</span>(sd<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>n <span class="sc">+</span> sd<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>n), <span class="at">df=</span>n<span class="sc">*</span><span class="dv">2-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$power
[1] 0.05000029

$typeS
[1] 0.4981533

$typeM
[1] 1492.75</code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
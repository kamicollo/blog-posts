<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Statistical guarantees and long-term error rates in A/B testing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="stat_guarantees_files/libs/clipboard/clipboard.min.js"></script>
<script src="stat_guarantees_files/libs/quarto-html/quarto.js"></script>
<script src="stat_guarantees_files/libs/quarto-html/popper.min.js"></script>
<script src="stat_guarantees_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="stat_guarantees_files/libs/quarto-html/anchor.min.js"></script>
<link href="stat_guarantees_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="stat_guarantees_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="stat_guarantees_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="stat_guarantees_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="stat_guarantees_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

<script src="stat_guarantees_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="stat_guarantees_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Statistical guarantees and long-term error rates in A/B testing</h1>
<p class="subtitle lead">Type I and II error rates don’t feel satisfactory, but getting to error rates that matter require Bayesian-like assumptions</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">TL;DR</h2>
<ul>
<li><p>The “statistical gurantees” in A/B testing (Type I and II error rates) only guarantee reproducibility of a single experiment. They don’t provide any assurance over # of wrong decisions (errors) you are likely to make over a series of experiments.</p></li>
<li><p>Type I error rate, in particular, is not very useful in the industry setting where small effect sizes still matter (from a business perspective, they are not equivalent to zero) and null hypothesis is, likely, never true.</p></li>
<li><p>Type S error (probability to observe a result with an opposite sign than the true effect) and Type M error (ratio of exaggeration of observed effect vs.&nbsp;true effect) are much more useful measures than pure Type I and Type II error rates.</p></li>
<li><p>You can only get to long-term error rates over series of experiments with Bayesian-like assumptions of effect size (experimental impact) distribution.</p></li>
<li><p>Depending on your belief of experiment impact distribution, running experiments that have <span class="math inline">\(80\%\)</span> estimated statistical power may yield very different long-term detection rates; <span class="math inline">\(80\%\)</span> detection rate is only achievable if you have a very succesful product team. Otherwise, it’s easy to arrive at <span class="math inline">\(50\%\)</span> and lower detection rates.</p></li>
<li><p>The risk of wrong decisions (Type S error) is minimal, <span class="math inline">\(0.2\% - 0.3\%\)</span>. Exageration errors are unavoidable (winner’s curse phenomenon), but running experiments at <span class="math inline">\(50\%\)</span> power or more reduces their impact considerably.</p></li>
</ul>
<p>Here’s a Streamlit app to estimate long-term error rates yourself.</p>
</section>
<section id="why-type-i-and-type-ii-error-rates-are-not-enough" class="level2">
<h2 class="anchored" data-anchor-id="why-type-i-and-type-ii-error-rates-are-not-enough">Why Type I and Type II error rates are not enough</h2>
<p>Suppose you’re the <em>Head of Something Data Related</em> in a company that runs many experiments annually, and your job is to ensure that the experimentation program is trustworthy. It’s still in the early stages of the experimentation journey in this company, so most tests use null hypothesis testing (NHT) with fixed sample sizes (although you’re looking into sequential testing and CUPED, too). You set the following rules for every experiment:</p>
<ul>
<li><p>Only experiments with a p-value &lt; 0.05 will be considered as having conclusive outcomes (you target a Type I error rate <span class="math inline">\(\alpha=0.05\)</span>).</p></li>
<li><p>Every experiment should be run with a predetermined sample size, which implies a power of 80% (you target a Type II error rate <span class="math inline">\(\beta=0.1\)</span>) for the selected minimum detectable effect (MDE).</p></li>
</ul>
<p>Setting aside the considerations on whether these are the <a href="https://aurimas.eu/blog/2023/02/getting-faster-to-decisions-in-a-b-tests-part-2-misinterpretations-and-practical-challenges-of-classical-hypothesis-testing/">best thresholds and other issues with using NHT</a>, here’s one question that, arguably, should matter to someone responsible for an experimentation program:</p>
<blockquote class="blockquote">
<p>What long-term error rates (a.k.a. bad decisions) can I expect if I run the experimentation program with such parameters?</p>
</blockquote>
<p>It may seem the answer is Type I and Type II error rates, or, “We will detect (i.e., declare them as statistically significant) differences when they exist, 80% of the time, and, in 5% of the cases we detect differences, they will be due to imperfect sampling randomization and not true differences”. But that is only true under a few conditions:</p>
<ul>
<li><p>You will have some experiments where the actual difference is precisely zero—not “close enough to zero,” but literally zero.</p></li>
<li><p>When estimating the required sample size in every experiment, you will always choose MDE precisely equal to the actual unobservable difference for that specific experiment.</p></li>
</ul>
<p>Neither of these conditions is likely to hold in the real world.</p>
<p>You can get around the second assumption if the MDE used is “minimum effect you care about”. Then, you can make a statement that “when the true effect is at least as large as the MDE, we will detect it with at least 80% of the time”. However, in the world of online experiments, do you really not care about detection rates of small effect sizes? A conversion rate improvement of 0.5 percentage point may still mean <em>many $$</em> annually. Achieving 80% power on such an effect size requires 3-4x sample size (depending on the baseline) than an 80% power on an effect size of 1 percentage point. Are you willing to make that trade-off and make all experiments 3-4x slower?</p>
<p>I’d argue that, in practice, practitioners tend to set MDEs above the minimum effects they care about. On top, conceptually, every experiment likely has a non-zero impact (they may be small, but not exactly zero - otherwise it may be worth disbanding the product team..). As a result, Type I and II error rates aren’t likely to represent the long-term error rates. They have not been designed for that. Instead, they represent frequentist statistics and its definition of probability—the likelihood of observing the same results if you run the same experiment repeatedly.</p>
<p>For <em>Head of Something Data,</em> however, knowing whether the results of a particular experiment hold may not be enough. You (should!) also want to know the long-term error rates.</p>
<p>For that, we need some other measures &amp; some other tools.</p>
</section>
<section id="moving-beyond-type-i-error-rates-type-m-and-s-errors" class="level2">
<h2 class="anchored" data-anchor-id="moving-beyond-type-i-error-rates-type-m-and-s-errors">Moving beyond Type I error rates: Type M and S errors</h2>
<p>Type I error rate, <span class="math inline">\(\alpha\)</span> is the most known statistical concept among everyone, including non-technical stakeholders. It’s probably the most misinterpreted one, too, given all the issues people have with p-values.</p>
<p>For something so popular, I’d argue it’s not so valuable because:</p>
<ul>
<li><p>It’s independent of the sample size. Isn’t that weird? No matter how much data you collect, you’re guaranteed that, if there’s no underlying difference, 5% of the time, you will still find statistically significant differences in the data when using a p-value of 0.05. Intuitively, one would think that more data equals more confidence in results, but the Type I error rate doesn’t change! Yes, the estimates become tighter, but the Type I error rate doesn’t measure that.</p></li>
<li><p>How often do you run experiments that have precisely no impact? Hopefully, never. So you’ll never need to worry about it! It’s tempting to approximate zero with “effect sizes so small they don’t matter,” but Type I error rates say nothing about small effect sizes.</p></li>
</ul>
<p><a href="https://journals.sagepub.com/doi/10.1177/1745691614551642">Gelman and Carlin</a> (2014) introduced two other metrics that I think are much more useful to consider:</p>
<ul>
<li><strong>Type S (sign) error.</strong> It’s the probability that an observed difference, when declared statistically significant, has an opposite sign than the actual difference. In other words, it is the probability that you will make a decision opposite to what you are after.</li>
<li><strong>Type M (Magnitude) error</strong> measures how much the observed difference, when declared statistically significant, differs from the actual difference, expressed as a ratio. It partially addresses the issue of quantifying the risk of declaring “effect sizes so small that they don’t practically matter” as statistically significant and is closely related to the <a href="https://www.etsy.com/codeascraft/mitigating-the-winners-curse-in-online-experiments?utm_source=pocket_reader">winner’s curse phenomenon</a>.</li>
</ul>
<p>Unlike Type I errors, type M and S error rates directly translate to business implications. Furthermore, they become smaller as sample sizes increase, as they operate in the “when the alternative hypothesis is true” land, i.e., when the effect sizes are not exactly zero.</p>
<section id="calculating-type-s-and-m-error-rates" class="level3">
<h3 class="anchored" data-anchor-id="calculating-type-s-and-m-error-rates">Calculating Type S and M error rates</h3>
<p>The original paper proposed calculating Type S and M error rates via simulation using the following function, where <span class="math inline">\(A\)</span> is the effect size, <span class="math inline">\(s\)</span> is the standard error, <span class="math inline">\(\alpha\)</span> is the chosen level of statistical significance, and <span class="math inline">\(df\)</span> represents the degrees of freedom.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>retrodesign <span class="ot">&lt;-</span> <span class="cf">function</span>(A, s, <span class="at">alpha=</span>.<span class="dv">05</span>, <span class="at">df=</span><span class="cn">Inf</span>, <span class="at">n.sims=</span><span class="dv">10000</span>){</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">&lt;-</span> <span class="fu">qt</span>(<span class="dv">1</span><span class="sc">-</span>alpha<span class="sc">/</span><span class="dv">2</span>, df)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  p.hi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">pt</span>(z<span class="sc">-</span>A<span class="sc">/</span>s, df)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  p.lo <span class="ot">&lt;-</span> <span class="fu">pt</span>(<span class="sc">-</span>z<span class="sc">-</span>A<span class="sc">/</span>s, df)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  power <span class="ot">&lt;-</span> p.hi <span class="sc">+</span> p.lo</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  typeS <span class="ot">&lt;-</span> p.lo<span class="sc">/</span>power</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  estimate <span class="ot">&lt;-</span> A <span class="sc">+</span> s<span class="sc">*</span><span class="fu">rt</span>(n.sims,df)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  significant <span class="ot">&lt;-</span> <span class="fu">abs</span>(estimate) <span class="sc">&gt;</span> s<span class="sc">*</span>z</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  exaggeration <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(estimate)[significant])<span class="sc">/</span>A</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">power=</span>power, <span class="at">typeS=</span>typeS, <span class="at">typeM=</span>exaggeration))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If we wanted to compute the metrics for a hypothetical A/B test with a binary outcome metric (e.g., conversion rate) where the baseline is <em>17%,</em> MDE of interest is 1 percentage point, and the sample size was 6000 users in each group:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n_group <span class="ot">=</span> <span class="dv">6000</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>baseline <span class="ot">=</span> <span class="fl">0.17</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate the baseline variance</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>baseline_var <span class="ot">=</span> baseline <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> baseline)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate standard error by estimating pooled variance</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>st_error <span class="ot">=</span> <span class="fu">sqrt</span>(baseline_var <span class="sc">/</span> n_group <span class="sc">+</span> baseline_var <span class="sc">/</span> n_group)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#degrees of freedom is N*2 - 2</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>df_test <span class="ot">=</span> n_group <span class="sc">*</span> <span class="dv">2</span> <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">#use Gelman's function to get error rate estimates</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>gelman_formula <span class="ot">=</span> <span class="fu">retrodesign</span>(<span class="at">A=</span>delta, <span class="at">s=</span>st_error, <span class="at">df =</span> df_test) <span class="sc">|&gt;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">method =</span> <span class="st">'Gelman/Carlin simulation'</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>gelman_formula <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">'Estimated Metrics'</span>) <span class="sc">|&gt;</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Estimated Metrics</caption>
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">power</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">typeS</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">typeM</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">method</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.3081444</td>
<td style="text-align: right;">0.0010259</td>
<td style="text-align: right;">1.78223</td>
<td style="text-align: left;">Gelman/Carlin simulation</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We can validate power calculations using R’s built-in function. Power estimates are very close (differences due to simulation error).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">power.prop.test</span>(<span class="at">n=</span>n_group, <span class="at">p1=</span>baseline, <span class="at">p2 =</span> baseline <span class="sc">+</span> delta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
     Two-sample comparison of proportions power calculation 

              n = 6000
             p1 = 0.17
             p2 = 0.18
      sig.level = 0.05
          power = 0.3020516
    alternative = two.sided

NOTE: n is number in *each* group</code></pre>
</div>
</div>
<p>In 2019, <a href="https://pubmed.ncbi.nlm.nih.gov/29569719/">Lu, Qui, and Deng</a> published a paper that includes closed-form formulas for these error rates. The implementation of them is straightforward, too (and can be easily extended to unequal sample size designs):</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>calculate_rates <span class="ot">=</span> <span class="cf">function</span>(delta, sd, n) {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># delta - effect size (MDE)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sd - baseline standard deviation</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># n - size per group</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">=</span> <span class="fu">abs</span>(delta) <span class="sc">/</span> <span class="fu">sqrt</span>(sd<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>n <span class="sc">+</span> sd<span class="sc">**</span><span class="dv">2</span><span class="sc">/</span>n)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">=</span> <span class="fu">qnorm</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.05</span><span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  neg <span class="ot">=</span> <span class="fu">pnorm</span>(<span class="sc">-</span>z <span class="sc">-</span>lambda)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  diff <span class="ot">=</span> <span class="fu">pnorm</span>(z <span class="sc">-</span> lambda)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  pos <span class="ot">=</span> <span class="fu">pnorm</span>(z <span class="sc">+</span> lambda)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  inv_diff <span class="ot">=</span> <span class="fu">pnorm</span>(lambda <span class="sc">-</span> z)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">power =</span> neg <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> diff,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">typeS =</span> neg <span class="sc">/</span> (neg <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> diff),</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">typeM =</span> (</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">dnorm</span>(lambda <span class="sc">+</span> z) <span class="sc">+</span> <span class="fu">dnorm</span>(lambda <span class="sc">-</span> z) <span class="sc">+</span> lambda <span class="sc">*</span> (pos <span class="sc">+</span> inv_diff <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">/</span> (lambda <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> pos <span class="sc">+</span> inv_diff))</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can verify that we get the same results:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>closed_form <span class="ot">=</span> <span class="fu">calculate_rates</span>(<span class="at">delta=</span>delta, <span class="at">sd=</span><span class="fu">sqrt</span>(baseline_var), <span class="at">n =</span> n_group) <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">method =</span> <span class="st">'Closed-form formula'</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(gelman_formula, closed_form) <span class="sc">|&gt;</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">'Estimated Metrics'</span>) <span class="sc">|&gt;</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Estimated Metrics</caption>
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">power</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">typeS</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">typeM</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">method</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.3081444</td>
<td style="text-align: right;">0.0010259</td>
<td style="text-align: right;">1.78223</td>
<td style="text-align: left;">Gelman/Carlin simulation</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.3082085</td>
<td style="text-align: right;">0.0010230</td>
<td style="text-align: right;">1.78321</td>
<td style="text-align: left;">Closed-form formula</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Finally, we can verify that all these formulas are correct with a small simulation. In this simulation, we repeat the same experiment with the above parameters many times and estimate empirical error rate estimates.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pboptions</span>(<span class="at">type=</span><span class="st">"none"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>sim_results <span class="ot">=</span> <span class="fu">pbsapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10000</span>, <span class="cf">function</span>(i) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(i<span class="sc">*</span><span class="dv">24</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">=</span> <span class="fu">rbinom</span>(n_group, <span class="dv">1</span>, baseline)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  B <span class="ot">=</span> <span class="fu">rbinom</span>(n_group, <span class="dv">1</span>, baseline <span class="sc">+</span> delta)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  mean_diff <span class="ot">=</span> <span class="fu">mean</span>(B) <span class="sc">-</span> <span class="fu">mean</span>(A)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> <span class="fu">t.test</span>(B, A)<span class="sc">$</span>p.value</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">detected =</span> p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">sign_error =</span> <span class="fu">ifelse</span>(p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>, <span class="fu">sign</span>(mean_diff) <span class="sc">!=</span> <span class="fu">sign</span>(delta), <span class="cn">NA</span>),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">ratio =</span> <span class="fu">ifelse</span>(p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>, mean_diff <span class="sc">/</span> delta, <span class="cn">NA</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>}, <span class="at">cl=</span><span class="dv">4</span>) <span class="sc">|&gt;</span> <span class="fu">t</span>() <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>empirical_rates <span class="ot">=</span> sim_results <span class="sc">|&gt;</span> <span class="fu">summarize</span>(</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">power =</span> <span class="fu">mean</span>(detected, <span class="at">na.rm=</span>T),</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">typeS =</span> <span class="fu">mean</span>(sign_error, <span class="at">na.rm=</span>T),</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">typeM =</span> <span class="fu">mean</span>(ratio, <span class="at">na.rm=</span>T),</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">'Empirical results'</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(gelman_formula, closed_form, empirical_rates) <span class="sc">|&gt;</span> </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">'Estimated Metrics'</span>) <span class="sc">|&gt;</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Estimated Metrics</caption>
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">power</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">typeS</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">typeM</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">method</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.3081444</td>
<td style="text-align: right;">0.0010259</td>
<td style="text-align: right;">1.782230</td>
<td style="text-align: left;">Gelman/Carlin simulation</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.3082085</td>
<td style="text-align: right;">0.0010230</td>
<td style="text-align: right;">1.783210</td>
<td style="text-align: left;">Closed-form formula</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.3043000</td>
<td style="text-align: right;">0.0016431</td>
<td style="text-align: right;">1.799376</td>
<td style="text-align: left;">Empirical results</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
</section>
<section id="quantifying-decision-making-risk-with-type-s-and-m-error-rates-in-a-single-experiment" class="level2">
<h2 class="anchored" data-anchor-id="quantifying-decision-making-risk-with-type-s-and-m-error-rates-in-a-single-experiment">Quantifying decision-making risk with Type S and M error rates in a single experiment</h2>
<p>Lu, Qiu, and Deng’s paper includes a few charts that I replicate below as they are excellent illustrations of the risk associated with Type S and M error rates. On the x-axis, we plot statistical power, and on the y-axis - Type S error rate / Type M ratio:</p>
<div class="cell">
<details>
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>error_rates <span class="ot">=</span> <span class="fu">lapply</span>(<span class="fu">seq</span>(<span class="dv">500</span>, <span class="dv">40000</span>, <span class="dv">500</span>), <span class="cf">function</span>(n) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">calculate_rates</span>(delta, <span class="fu">sqrt</span>(baseline_var), n)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="sc">-</span>power)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(error_rates, <span class="fu">aes</span>(<span class="at">x=</span>power)) <span class="sc">+</span> </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>value, <span class="at">color=</span>name)) <span class="sc">+</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">scales=</span><span class="st">'free_y'</span>) <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="stat_guarantees_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>We can see that Type S error (which is really bad, decision-making-wise!) largely disappears once we hit power of &nbsp;0.35−0.4. On the other hand, the type M ratio only goes below 1.5x once we achieve the statistical power of <span class="math inline">\(0.5\)</span>. If this does not illustrate the issues with underpowered experiments, I don’t know what does!</p>
</section>
<section id="from-type-iims-errors-to-long-term-error-rates" class="level2">
<h2 class="anchored" data-anchor-id="from-type-iims-errors-to-long-term-error-rates">From Type II/M/S errors to long-term error rates</h2>
<p><img src="gohanks.jpg" class="img-fluid"></p>
<p>In my opinion, Type S and M error rates are much more helpful than pure Type I and II errors. However, just like Type II errors, they are not long-term error rates unless we assume we will perfectly set the MDE to the actual effect size in each experiment. If we could do that, we would not need to run experiments!</p>
<p>We could skirt around this issue by reframing error rates to focus on limits/margins, similar to how it’s done with MDE. However, a statement like “we have at most X% risk of sign error when we detect statistically significant results and the underlying effect size is at least Y” does not feel very satisfactory.</p>
<p>Can we do better?</p>
<p>We can, but it requires an additional assumption (there is no free lunch, as always!). We’ll borrow an idea from Bayesian statistics: instead of working with fixed values, we can assume a distribution of likely effect sizes (a.k.a. prior distribution)and then integrate over that distribution to get expected error rates.</p>
<section id="some-potential-effect-size-distributions" class="level3">
<h3 class="anchored" data-anchor-id="some-potential-effect-size-distributions">Some potential effect size distributions</h3>
<p>How do we select potential treatment size distributions? It’s subjective and depends on what you believe! I will use four hypothetical cases:</p>
<ul>
<li><p><strong>Typical team</strong>. On average, it achieves a <span class="math inline">\(1.5\)</span> percentage point improvement in a metric of interest. The team is as likely to ship experiments that deviate positively from the average as they do negatively, with ~15% of experiments resulting in adverse impact and most experiments falling within <span class="math inline">\(0-4.5\)</span> percentage point improvements.</p></li>
<li><p><strong>Downside-protected team.</strong> This team ships experiments with the same average impact, but the distribution is not symmetric. There is a longer tail of positive effects and no situations where experiments do extremely poorly (because of safeguards such as dogfooding, UXR, etc.).</p></li>
<li><p><strong>Fifty-fifty team.</strong> This team ships experiments with the same variance as the typical team, but their win rate is just 50/50.</p></li>
<li><p><strong>Golden team.</strong> A team that’s hard to beat - they primarily ship winning experiments, and some of them reach up to <span class="math inline">\(5\)</span> percentage point improvements.</p></li>
</ul>
<div class="cell">
<details>
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>avg_treatment_effect <span class="ot">=</span> <span class="fl">0.015</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>sd_treatment_effect <span class="ot">=</span> <span class="fl">0.014</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>eff_size_distrs <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">'Typical team'</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">distr =</span> <span class="st">'N(0.015, 0.014)'</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">generator =</span> <span class="cf">function</span>() <span class="fu">rnorm</span>(<span class="dv">1</span>, avg_treatment_effect, sd_treatment_effect),</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">density =</span> <span class="cf">function</span>(x) <span class="fu">dnorm</span>(x, <span class="at">mean =</span> avg_treatment_effect, <span class="at">sd =</span> sd_treatment_effect) </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">'Fifty-fifty team'</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">distr =</span> <span class="st">'N(0, 0.014)'</span>,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">generator =</span> <span class="cf">function</span>() <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sd_treatment_effect),</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">density =</span> <span class="cf">function</span>(x) <span class="fu">dnorm</span>(x, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sd_treatment_effect) </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">'Downside-protected team'</span>,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">distr =</span> <span class="st">'shifted/scaled Gamma(2,2))'</span>,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">generator =</span> <span class="cf">function</span>() <span class="fu">rgamma</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>) <span class="sc">/</span> <span class="dv">50</span> <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">50</span> <span class="sc">+</span> avg_treatment_effect,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">density =</span> <span class="cf">function</span>(x) <span class="fu">dgamma</span>((x <span class="sc">-</span> avg_treatment_effect <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">50</span>) <span class="sc">*</span> <span class="dv">50</span>, <span class="dv">2</span>, <span class="dv">2</span>) <span class="sc">*</span> <span class="dv">50</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">'Golden team'</span>,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">distr =</span> <span class="st">'shifted/scaled Gamma(3,2)'</span>,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">generator =</span> <span class="cf">function</span>() <span class="fu">rgamma</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>) <span class="sc">/</span> <span class="dv">50</span> <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">50</span> <span class="sc">+</span> avg_treatment_effect,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">density =</span> <span class="cf">function</span>(x) <span class="fu">dgamma</span>((x <span class="sc">-</span> avg_treatment_effect <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">50</span>) <span class="sc">*</span> <span class="dv">50</span>, <span class="dv">3</span>, <span class="dv">2</span>) <span class="sc">*</span> <span class="dv">50</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>emp <span class="ot">=</span> <span class="fu">lapply</span>(</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  eff_size_distrs,</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(d) {</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    r[[d<span class="sc">$</span>name]] <span class="ot">=</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50000</span>, <span class="cf">function</span>(i) d<span class="sc">$</span><span class="fu">generator</span>())</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    r</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">bind_cols</span>() <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"Assumed distribution"</span>)</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(emp) <span class="sc">+</span> </span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x=</span>value, <span class="at">color=</span><span class="st">`</span><span class="at">Assumed distribution</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>  eff_size_distrs, </span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(d) <span class="fu">stat_function</span>(</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">color=</span>d<span class="sc">$</span>name, <span class="at">fill=</span>d<span class="sc">$</span>name), </span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">fun =</span> d<span class="sc">$</span>density,</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">name =</span> d<span class="sc">$</span>name, <span class="at">full_name =</span> <span class="fu">paste</span>(d<span class="sc">$</span>name, <span class="st">'~'</span>, d<span class="sc">$</span>distr)),</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom=</span><span class="st">"area"</span>,</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha=</span><span class="fl">0.5</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> </span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="sc">-</span><span class="fl">0.05</span>, <span class="fl">0.1</span>) <span class="sc">+</span> <span class="fu">labs</span>(</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">y=</span><span class="st">'Density'</span>,</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span><span class="st">'Assumed effect size distribution'</span>,</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">x=</span><span class="st">'Effect size'</span>,</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">title=</span><span class="st">'Some possible effect size assumptions'</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>full_name) <span class="sc">+</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">'dotted'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="stat_guarantees_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="768"></p>
</div>
<details>
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>emp <span class="sc">|&gt;</span> <span class="fu">group_by</span>(<span class="st">`</span><span class="at">Assumed distribution</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Avg. effect</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(value),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q10 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.1</span>),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q90 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.9</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span><span class="st">`</span><span class="at">Avg. effect</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">'Summary statistics of assumed effect size distributions'</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Summary statistics of assumed effect size distributions</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Assumed distribution</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Avg. effect</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Q10</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Q90</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Golden team</td>
<td style="text-align: right;">0.0250048</td>
<td style="text-align: right;">0.0058990</td>
<td style="text-align: right;">0.0483748</td>
</tr>
<tr class="even">
<td style="text-align: left;">Downside-protected team</td>
<td style="text-align: right;">0.0149691</td>
<td style="text-align: right;">0.0003038</td>
<td style="text-align: right;">0.0338062</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Typical team</td>
<td style="text-align: right;">0.0149349</td>
<td style="text-align: right;">-0.0029794</td>
<td style="text-align: right;">0.0329643</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fifty-fifty team</td>
<td style="text-align: right;">-0.0000161</td>
<td style="text-align: right;">-0.0178059</td>
<td style="text-align: right;">0.0180195</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="estimating-long-term-error-rates" class="level3">
<h3 class="anchored" data-anchor-id="estimating-long-term-error-rates">Estimating long term error rates</h3>
<p>Suppose we believe our average treatment effect is <span class="math inline">\(0.015\)</span>. In a standard setting, we may choose to use it as an MDE. We could estimate the sample size required to achieve 80% power and a <span class="math inline">\(17\%\)</span> conversion baseline - that’s about 10,200 observations per group.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>required_sample_size <span class="ot">=</span> <span class="fu">ceiling</span>(<span class="fu">power.prop.test</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">p1=</span>baseline, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">p2=</span>baseline <span class="sc">+</span> avg_treatment_effect, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">power=</span><span class="fl">0.8</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>)<span class="sc">$</span>n)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>required_sample_size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10185</code></pre>
</div>
</div>
<p>We can also estimate the corresponding Type S and M error rates given this particular treatment effect and sample size:</p>
<div class="cell">
<details>
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">calculate_rates</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta =</span> avg_treatment_effect, </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="fu">sqrt</span>(baseline <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> baseline)),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> required_sample_size</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to=</span><span class="st">'Metric'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption=</span><span class="st">'Error rates at aa fixed effect size'</span>) <span class="sc">|&gt;</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Error rates at aa fixed effect size</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Metric</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">power</td>
<td style="text-align: right;">0.8131866</td>
</tr>
<tr class="even">
<td style="text-align: left;">typeS</td>
<td style="text-align: right;">0.0000009</td>
</tr>
<tr class="odd">
<td style="text-align: left;">typeM</td>
<td style="text-align: right;">1.1158885</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Now, let’s instead calculate our “expected detection rate” (“average power”) by integrating over the prior distributions:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>estimate_power <span class="ot">=</span> <span class="cf">function</span>(baseline, required_sample_size, density_func) {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">integrate</span>(<span class="cf">function</span>(x) {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">=</span> <span class="fu">calculate_rates</span>(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">n=</span>required_sample_size, </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">delta=</span>x,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd=</span><span class="fu">sqrt</span>(baseline <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span> baseline))</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">$</span>power</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">density_func</span>(x) <span class="sc">*</span> <span class="fu">replace_na</span>(p, <span class="dv">0</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  }, <span class="sc">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>)<span class="sc">$</span>value</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Assumed effect size distribution</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sapply</span>(eff_size_distrs, <span class="cf">function</span>(x) x<span class="sc">$</span>name),</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">P(detect | effect size distribution, N, baseline)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sapply</span>(</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    eff_size_distrs,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">estimate_power</span>(baseline, required_sample_size, x<span class="sc">$</span>density)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="at">caption=</span><span class="st">'Long-run detection rates'</span>) <span class="sc">|&gt;</span> <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Long-run detection rates</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Assumed effect size distribution</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">P(detect | effect size distribution, N, baseline)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Typical team</td>
<td style="text-align: right;">0.6681627</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fifty-fifty team</td>
<td style="text-align: right;">0.4903372</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Downside-protected team</td>
<td style="text-align: right;">0.5667470</td>
</tr>
<tr class="even">
<td style="text-align: left;">Golden team</td>
<td style="text-align: right;">0.7908594</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We can see that “average statistical power” (i.e.&nbsp;the probability we will declare an observed difference as statistically significant given our assumptions about sample size, baseline metric value, and effect size distribution):</p>
<ul>
<li><p>It is lower than the 80% that the classical MDE calculation yields — which is not unexpected, as the latter only considers effect size equal to the MDE, while prior distributions include a lot of density of smaller effect sizes.</p></li>
<li><p>Anywhere between <span class="math inline">\(49\%\)</span> and <span class="math inline">\(79\%\)</span> - prior distribution assumption matters a lot!</p></li>
</ul>
<p>We can also plot expected detection rates as a function of statistical power using a fixed MDE.</p>
<div class="cell">
<details>
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.99</span>, <span class="fl">0.01</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>avg_p <span class="ot">=</span> <span class="fu">pblapply</span>(p, <span class="cf">function</span>(power) {</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">=</span> <span class="fu">ceiling</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">power.prop.test</span>(</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">p1=</span>baseline, </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">p2=</span>baseline <span class="sc">+</span> avg_treatment_effect, </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">power=</span>power</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">$</span>n</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(eff_size_distrs, <span class="cf">function</span>(d) {</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">name =</span> d<span class="sc">$</span>name, <span class="at">v =</span> <span class="fu">estimate_power</span>(baseline, n, d<span class="sc">$</span>density), <span class="at">power=</span>power)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>}, <span class="at">cl=</span><span class="dv">4</span>) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(avg_p) <span class="sc">+</span> </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span> power, <span class="at">y=</span>v, <span class="at">color=</span>name)) <span class="sc">+</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope=</span><span class="dv">1</span>, <span class="at">linetype=</span><span class="st">'dotted'</span>) <span class="sc">+</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.8</span>, <span class="at">linetype=</span><span class="st">'dashed'</span>) <span class="sc">+</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> <span class="fu">labs</span>(</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">'Power @ MDE'</span>,</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">'Avg. expected detection rate'</span>,</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">'Assumed effect size distribution'</span>,</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Long-run effect detection rates'</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="stat_guarantees_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>An <a href="https://hdsr.mitpress.mit.edu/pub/aj31wj81/release/1">often-quoted</a> figure for the win rate in online experiments is <span class="math inline">\(10-20\%\)</span>. The detection rate also includes experiments with a negative impact, so it’s not a 1:1 comparison, but it seems that these prior distributions are way too optimistic! Or, alternatively, the MDEs used in practice are too high, resulting in low power.</p>
<p>We can do the same with Type S error and Type M error. I will make one tweak to the definitions, though: instead of focusing on conditional error rates (“when the result is statistically significant, what is the probability…”), I’ll estimate the overall error rates (“out of all experiments that we run, what’s the probability that..”). I think these rates are more helpful to think about when considering long-term error rates, as they tell us probabilities of error with all experiments as the denominator. If needed, we can divide them by the average detection rate to get back to original Type S and M definitions.</p>
<p>We can see that, on average, the risk of sign error is <span class="math inline">\(0.2\%-0.3\%\)</span>. That is much higher than what a fixed effect size calculation suggests, but, as a long-term error rate, that’s still very low.</p>
<div class="cell">
<details>
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>estimate_typeS <span class="ot">=</span> <span class="cf">function</span>(baseline, s, density_func) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  baseline_sd <span class="ot">=</span> <span class="fu">sqrt</span>(baseline <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> baseline))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">integrate</span>(<span class="cf">function</span>(x) {</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">=</span> <span class="fu">calculate_rates</span>(<span class="at">n=</span>s, <span class="at">delta=</span>x, <span class="at">sd=</span>baseline_sd)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    (r<span class="sc">$</span>typeS <span class="sc">*</span> r<span class="sc">$</span>power) <span class="sc">*</span> <span class="fu">density_func</span>(x)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  }, <span class="sc">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>, <span class="at">stop.on.error =</span> F)<span class="sc">$</span>value</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.99</span>, <span class="fl">0.01</span>)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>avg_sign_error <span class="ot">=</span> <span class="fu">pblapply</span>(p, <span class="cf">function</span>(power) {</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">=</span> <span class="fu">ceiling</span>(</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">power.prop.test</span>(</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">p1=</span>baseline, </span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">p2=</span>baseline <span class="sc">+</span> avg_treatment_effect, </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">power=</span>power</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">$</span>n</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(eff_size_distrs, <span class="cf">function</span>(d) {</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">name =</span> d<span class="sc">$</span>name, <span class="at">v =</span> <span class="fu">estimate_typeS</span>(baseline, n, d<span class="sc">$</span>density), <span class="at">power=</span>power)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>}, <span class="at">cl=</span><span class="dv">4</span>) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(avg_sign_error) <span class="sc">+</span> </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span> power, <span class="at">y=</span>v, <span class="at">color=</span>name)) <span class="sc">+</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> <span class="fu">labs</span>(</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">'Power @ MDE'</span>,</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">'Error rate'</span>,</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">'Assumed effect size distribution'</span>,</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Long-run sign error rates'</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.8</span>, <span class="at">linetype=</span><span class="st">'dashed'</span>) <span class="sc">+</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.015</span>, <span class="fl">0.002</span>)) <span class="sc">+</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="stat_guarantees_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>Type M is a bit trickier because it’s a ratio, and integrating it at small effect sizes is challenging as the ratio’s denominator approaches zero. Instead of estimating the “average Type M ratio”, I will estimate “average absolute exaggeration”. That is:</p>
<p><span class="math display">\[
\text{Absolute exaggeration} = | \text{true effect size} - \text{observed effect size} | \text{ if results are statistically significant, else 0}
\]</span></p>
<p>We can see that it works out to be <span class="math inline">\(~0.1\)</span> percentage point at power of <span class="math inline">\(80\%\)</span> (using MDE of <span class="math inline">\(1.5\%\)</span>).</p>
<p>This approach, by the way, gets us quite close to expected loss metric used in Bayesian A/B testing, where instead of just capturing the cost of an error as a binary one (like we did above with power or sign error), we capture the magnitude of it, too (a sign error on an estimated effect size of <span class="math inline">\(5\)</span> percentage point is not the same as one on an effect size of <span class="math inline">\(0.5\)</span> percentage point!). But that’s for a future blog post.</p>
<div class="cell">
<details>
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>estimate_typeM <span class="ot">=</span> <span class="cf">function</span>(baseline, s, density_func) {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  baseline_sd <span class="ot">=</span> <span class="fu">sqrt</span>(baseline <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> baseline))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">integrate</span>(<span class="cf">function</span>(x) {</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">=</span> <span class="fu">calculate_rates</span>(<span class="at">n=</span>s, <span class="at">delta=</span>x, <span class="at">sd=</span>baseline_sd)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    (r<span class="sc">$</span>typeM <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">density_func</span>(x) <span class="sc">*</span> <span class="fu">abs</span>(x) <span class="sc">*</span> r<span class="sc">$</span>power</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  }, <span class="sc">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>, <span class="at">stop.on.error =</span> F)<span class="sc">$</span>value</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.99</span>, <span class="fl">0.01</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>avg_misestimate <span class="ot">=</span> <span class="fu">pblapply</span>(p, <span class="cf">function</span>(power) {</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">=</span> <span class="fu">ceiling</span>(</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">power.prop.test</span>(</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">p1=</span>baseline, </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">p2=</span>baseline <span class="sc">+</span> avg_treatment_effect, </span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">power=</span>power</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">$</span>n</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(eff_size_distrs, <span class="cf">function</span>(d) {</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">name =</span> d<span class="sc">$</span>name, <span class="at">v =</span> <span class="fu">estimate_typeM</span>(baseline, n, d<span class="sc">$</span>density), <span class="at">power=</span>power)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>}, <span class="at">cl=</span><span class="dv">4</span>) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(avg_misestimate) <span class="sc">+</span> </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span> power, <span class="at">y=</span>v, <span class="at">color=</span>name)) <span class="sc">+</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> <span class="fu">labs</span>(</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">'Power @ MDE'</span>,</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">'Avg. absolute exaggeration'</span>,</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">'Assumed effect size distribution'</span>,</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Long-run exaggeration rates'</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.8</span>, <span class="at">linetype=</span><span class="st">'dashed'</span>) <span class="sc">+</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.01</span>, <span class="fl">0.001</span>)) <span class="sc">+</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="stat_guarantees_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>And that’s it. All that’s left is to come up with prior distributions, MDE, and estimate long-term error rates on your own. I made a small Streamlit app just for that.</p>
</section>
</section>
<section id="appendix---i-dont-trust-the-maths" class="level2">
<h2 class="anchored" data-anchor-id="appendix---i-dont-trust-the-maths">Appendix - I don’t trust the maths</h2>
<p>Me neither. So I ran another simulation just to double check - looks like it all adds up. Exaggeration ratios are a bit off, but I suspect that differences arise from numerical approximations in integration.</p>
<div class="cell">
<details>
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>num_experiments <span class="ot">=</span> <span class="dv">100000</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>used_sample_size <span class="ot">=</span> <span class="fu">floor</span>(<span class="fu">power.prop.test</span>(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">p1=</span>baseline, </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">p2=</span>baseline <span class="sc">+</span> <span class="fl">0.015</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">power=</span><span class="fl">0.2</span>)<span class="sc">$</span>n)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>appendix_sim <span class="ot">=</span> <span class="fu">pblapply</span>(eff_size_distrs, <span class="cf">function</span>(d) {</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  drawn_effect_sizes <span class="ot">=</span> <span class="fu">sapply</span>(</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span>num_experiments, </span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(i) d<span class="sc">$</span><span class="fu">generator</span>()</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  exp_results <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">eff_size =</span> drawn_effect_sizes,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">converted_A =</span> <span class="fu">rbinom</span>(</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>      num_experiments, </span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>      used_sample_size, </span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>      baseline</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">converted_B =</span> <span class="fu">rbinom</span>(</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>      num_experiments, </span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>      used_sample_size, </span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>      baseline <span class="sc">+</span> drawn_effect_sizes</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">|&gt;</span> <span class="fu">mutate</span>(</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">conv_rate_A =</span> converted_A <span class="sc">/</span> used_sample_size,</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">conv_rate_B =</span> converted_B <span class="sc">/</span> used_sample_size,</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_diff =</span> conv_rate_B <span class="sc">-</span> conv_rate_A,</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">st_error =</span> <span class="fu">sqrt</span>(</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>      (conv_rate_A <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> conv_rate_A) <span class="sc">/</span> used_sample_size) <span class="sc">+</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>      (conv_rate_B <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> conv_rate_B) <span class="sc">/</span> used_sample_size)</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">is_stat_sig =</span> <span class="fu">abs</span>(mean_diff <span class="sc">/</span> st_error) <span class="sc">&gt;=</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>)</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">sign_error =</span> <span class="fu">if_else</span>(</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>        is_stat_sig, </span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sign</span>(mean_diff) <span class="sc">!=</span> <span class="fu">sign</span>(drawn_effect_sizes), </span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>        <span class="cn">NA</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">exaggeration =</span> <span class="fu">if_else</span>(is_stat_sig, <span class="fu">abs</span>(mean_diff <span class="sc">-</span> drawn_effect_sizes), <span class="cn">NA</span>)</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>  exp_results <span class="sc">|&gt;</span> <span class="fu">summarize</span>(</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">distribution =</span> d<span class="sc">$</span>name,</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_power =</span> <span class="fu">mean</span>(is_stat_sig),</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_sign_error =</span> <span class="fu">mean</span>(<span class="fu">replace_na</span>(sign_error, F)),</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_exaggeration =</span> <span class="fu">mean</span>(<span class="fu">replace_na</span>(exaggeration, <span class="dv">0</span>)),</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_TypeS =</span> <span class="fu">mean</span>(sign_error, <span class="at">na.rm=</span>T),</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_conditional_exaggeration =</span> <span class="fu">mean</span>(exaggeration, <span class="at">na.rm=</span>T)</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>appendix_sim <span class="sc">|&gt;</span> </span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption=</span><span class="st">'Simulation results using N = 20% power at MDE of 0.015'</span>, <span class="at">digits=</span><span class="dv">4</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Simulation results using N = 20% power at MDE of 0.015</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">distribution</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">avg_power</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">avg_sign_error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">avg_exaggeration</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">avg_TypeS</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">avg_conditional_exaggeration</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Typical team</td>
<td style="text-align: right;">0.2927</td>
<td style="text-align: right;">0.0041</td>
<td style="text-align: right;">0.0039</td>
<td style="text-align: right;">0.0140</td>
<td style="text-align: right;">0.0134</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fifty-fifty team</td>
<td style="text-align: right;">0.1805</td>
<td style="text-align: right;">0.0066</td>
<td style="text-align: right;">0.0030</td>
<td style="text-align: right;">0.0364</td>
<td style="text-align: right;">0.0167</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Downside-protected team</td>
<td style="text-align: right;">0.2602</td>
<td style="text-align: right;">0.0059</td>
<td style="text-align: right;">0.0037</td>
<td style="text-align: right;">0.0226</td>
<td style="text-align: right;">0.0141</td>
</tr>
<tr class="even">
<td style="text-align: left;">Golden team</td>
<td style="text-align: right;">0.4375</td>
<td style="text-align: right;">0.0024</td>
<td style="text-align: right;">0.0052</td>
<td style="text-align: right;">0.0055</td>
<td style="text-align: right;">0.0118</td>
</tr>
</tbody>
</table>


</div>
<details>
<summary>Show code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(eff_size_distrs, <span class="cf">function</span>(d) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">distribution =</span> d<span class="sc">$</span>name,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_power =</span> <span class="fu">estimate_power</span>(</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">baseline =</span> baseline, </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">required_sample_size =</span> used_sample_size, </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">density_func =</span> d<span class="sc">$</span>density</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_sign_error =</span> <span class="fu">estimate_typeS</span>(</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">baseline =</span> baseline, </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">s =</span> used_sample_size, </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">density_func =</span> d<span class="sc">$</span>density</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_exaggeration =</span> <span class="fu">estimate_typeM</span>(</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">baseline =</span> baseline, </span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">s =</span> used_sample_size, </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">density_func =</span> d<span class="sc">$</span>density</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span> </span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_TypeS =</span> avg_sign_error <span class="sc">/</span> avg_power,</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_conditional_exaggeration =</span> avg_exaggeration <span class="sc">/</span> avg_power</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">caption=</span><span class="st">'Integration results with equivalent parameters'</span>, <span class="at">digits=</span><span class="dv">4</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Integration results with equivalent parameters</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">distribution</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">avg_power</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">avg_sign_error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">avg_exaggeration</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">avg_TypeS</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">avg_conditional_exaggeration</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Typical team</td>
<td style="text-align: right;">0.3033</td>
<td style="text-align: right;">0.0040</td>
<td style="text-align: right;">0.0034</td>
<td style="text-align: right;">0.0132</td>
<td style="text-align: right;">0.0113</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fifty-fifty team</td>
<td style="text-align: right;">0.1790</td>
<td style="text-align: right;">0.0065</td>
<td style="text-align: right;">0.0029</td>
<td style="text-align: right;">0.0365</td>
<td style="text-align: right;">0.0160</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Downside-protected team</td>
<td style="text-align: right;">0.2678</td>
<td style="text-align: right;">0.0060</td>
<td style="text-align: right;">0.0030</td>
<td style="text-align: right;">0.0223</td>
<td style="text-align: right;">0.0110</td>
</tr>
<tr class="even">
<td style="text-align: left;">Golden team</td>
<td style="text-align: right;">0.4498</td>
<td style="text-align: right;">0.0023</td>
<td style="text-align: right;">0.0033</td>
<td style="text-align: right;">0.0051</td>
<td style="text-align: right;">0.0074</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>